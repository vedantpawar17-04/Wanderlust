<%# Listings Index Page - Main page that displays all property listings with search and filter options %>
<% layout('/layouts/boilerplate') -%>
<link rel="stylesheet" href="/css/index.css">

<div class="container listings-container">
    <%# Show different header and back button when displaying search results %>
    <% if (typeof searchQuery !== 'undefined' && searchQuery) { %>
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="listings-header mb-0">Search Results for "<%= searchQuery %>"</h1>
            <%# Filter Button for search results %>
            <button class="btn btn-primary filter-btn" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="false" aria-controls="filterCollapse">
                <i class="fa-solid fa-filter me-2"></i>Filter Results
            </button>
        </div>
        <%# Back button to return to all listings %>
        <div class="text-center mb-4">
            <a href="/listings" class="btn btn-outline-dark rounded-pill px-4">
                <i class="fa-solid fa-arrow-left me-2"></i>Back to All Listings
            </a>
        </div>
        <%# No results message when search returns empty %>
        <% if (allListing.length === 0) { %>
            <div class="alert alert-info text-center p-4 mb-4">
                <i class="fa-solid fa-magnifying-glass me-2 fs-4"></i>
                <p class="mb-0 fs-5">No listings found matching "<%= searchQuery %>". Try another location.</p>
            </div>
        <% } %>
    <%# Default header for main listings page %>
    <% } else { %>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="listings-header mb-0"><b>Explore Our Unique Destinations</b></h5>
            <button class="btn btn-filter" type="button" 
                    data-bs-toggle="collapse" 
                    data-bs-target="#filterCollapse" 
                    aria-expanded="false" 
                    aria-controls="filterCollapse"
                    data-bs-toggle="popover"
                    data-bs-content="Click to show/hide filter options"
                    data-bs-placement="left">
                <i class="fa-solid fa-sliders me-2"></i>Filters
            </button>
        </div>
    <% } %>
    
    <%# Filter Section %>
    <div class="filter-container mb-4">
        <div class="collapse" id="filterCollapse">
            <div class="filter-card bg-white p-4">
                <form id="filterForm" action="/listings" method="GET">
                    <div class="row g-3">
                        <%# Country/Region dropdown filter %>
                        <div class="col-md-4">
                            <div class="filter-group">
                                <label class="d-flex align-items-center mb-2">
                                    <i class="fa-solid fa-globe me-2 text-muted"></i>
                                    <span>Country</span>
                                    <i class="fa-solid fa-circle-info ms-2 text-muted" 
                                       data-bs-toggle="popover" 
                                       data-bs-content="Filter listings by country or region"
                                       style="cursor: help;"></i>
                                </label>
                                <select class="form-select" id="country" name="country">
                                    <option value="all">All Countries</option>
                                    <% allCountries.forEach(country => { %>
                                        <option value="<%= country %>" <%= filters && filters.country === country ? 'selected' : '' %>>
                                            <%= country %>
                                        </option>
                                    <% }) %>
                                </select>
                            </div>
                        </div>
                        
                        <%# Price Range filters %>
                        <div class="col-md-6">
                            <div class="filter-group">
                                <label class="d-flex align-items-center mb-2">
                                    <i class="fa-solid fa-indian-rupee-sign me-2 text-muted"></i>
                                    <span>Price Range</span>
                                    <i class="fa-solid fa-circle-info ms-2 text-muted" 
                                       data-bs-toggle="popover" 
                                       data-bs-content="Set minimum and maximum price per night"
                                       style="cursor: help;"></i>
                                </label>
                                <div class="d-flex gap-3">
                                    <div class="flex-grow-1">
                                        <input type="number" class="form-control" id="minPrice" name="minPrice" 
                                            placeholder="Min Price"
                                            min="<%= priceRange.min %>" 
                                            max="<%= priceRange.max %>" 
                                            value="<%= filters ? filters.minPrice : '' %>"
                                            data-bs-toggle="popover"
                                            data-bs-content="Minimum price per night must be greater than 2500"
                                            data-bs-placement="top"
                                            data-bs-trigger="focus">
                                    </div>
                                    <div class="flex-grow-1">
                                        <input type="number" class="form-control" id="maxPrice" name="maxPrice" 
                                            placeholder="Max Price"
                                            min="<%= priceRange.min %>" 
                                            max="<%= priceRange.max %>" 
                                            value="<%= filters ? filters.maxPrice : '' %>"
                                            data-bs-toggle="popover"
                                            data-bs-content="Maximum price per night must be greater than and equal to 2500"
                                            data-bs-placement="top"
                                            data-bs-trigger="focus">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <%# Filter action buttons %>
                        <div class="col-md-2 d-flex align-items-end">
                            <div class="d-flex gap-2 w-100">
                                <button type="submit" class="btn btn-filter-apply"
                                        data-bs-toggle="popover"
                                        data-bs-content="Apply selected filters"
                                        data-bs-placement="top">
                                    Apply
                                </button>
                                <button type="button" 
                                       class="btn btn-filter-clear"
                                       data-bs-toggle="popover"
                                       data-bs-content="Clear all filters"
                                       data-bs-placement="top"
                                       onclick="clearFilters()">
                                    Clear
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <%# Active Filters Display %>
    <% if (filters && (filters.country !== 'all' || filters.minPrice || filters.maxPrice)) { %>
        <div class="active-filters d-flex flex-wrap gap-2 mb-4">
            <% if (filters.country !== 'all') { %>
                <div class="filter-badge">
                    <i class="fa-solid fa-globe me-2"></i>
                    <%= filters.country %>
                    <a href="/listings<%= 
                        filters.minPrice ? '?minPrice=' + filters.minPrice : '' %><%= 
                        filters.maxPrice ? (filters.minPrice ? '&' : '?') + 'maxPrice=' + filters.maxPrice : '' %>" 
                        class="filter-remove ms-2">×</a>
                </div>
            <% } %>
            
            <% if (filters.minPrice) { %>
                <div class="filter-badge">
                    <i class="fa-solid fa-indian-rupee-sign me-2"></i>
                    Min: ₹<%= filters.minPrice %>
                    <a href="/listings<%= 
                        filters.country !== 'all' ? '?country=' + filters.country : '' %><%= 
                        filters.maxPrice ? (filters.country !== 'all' ? '&' : '?') + 'maxPrice=' + filters.maxPrice : '' %>" 
                        class="filter-remove ms-2">×</a>
                </div>
            <% } %>
            
            <% if (filters.maxPrice) { %>
                <div class="filter-badge">
                    <i class="fa-solid fa-indian-rupee-sign me-2"></i>
                    Max: ₹<%= filters.maxPrice %>
                    <a href="/listings<%= 
                        filters.country !== 'all' ? '?country=' + filters.country : '' %><%= 
                        filters.minPrice ? (filters.country !== 'all' ? '&' : '?') + 'minPrice=' + filters.minPrice : '' %>" 
                        class="filter-remove ms-2">×</a>
                </div>
            <% } %>
            
            <a href="/listings" class="filter-clear">
                Clear All
            </a>
        </div>
    <% } %>

    <%# Listings Grid - Card display of all property listings %>
    <div class="row mt-4">
        <% // Sort the listings based on review count 
            const sortedListings=allListing.sort((a, b)=> {
            const reviewCountA = a.reviews ? a.reviews.length : 0;
            const reviewCountB = b.reviews ? b.reviews.length : 0;
            return reviewCountB - reviewCountA; // Sort in descending order
            });

            for(let i=0; i < sortedListings.length; i++){ %>
                <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                    <div class="card listing-cards h-100">
                        <%# Listing image with optional badge %>
                        <div class="card-img-container">
                            <img src="<%= sortedListings[i].image.url %>" class="card-img-top" alt="<%= sortedListings[i].title %>">
                            <div class="card-img-overlay d-flex flex-column justify-content-between">
                            </div>
                        </div>
                        <%# Listing details %>
                        <div class="card-body d-flex flex-column">
                            <div class="listing-title"><%= sortedListings[i].title %></div>
                            <div class="listing-price">₹<%= sortedListings[i].price.toLocaleString('en-IN') %> <span class="fw-normal">/ night</span></div>
                            <%# Reviews information %>
                            <div class="listing-reviews mt-2">
                                <% if (sortedListings[i].reviews && sortedListings[i].reviews.length > 0) { %>
                                    <i class="fa-solid fa-star text-warning me-1"></i> Reviews: <%= sortedListings[i].reviews.length %>
                                <% } else { %>
                                    <i class="fa-regular fa-star text-secondary me-1"></i> No reviews yet
                                <% } %>
                            </div>
                            <%# Location information %>
                            <div class="mt-2 text-muted">
                                <i class="fa-solid fa-location-dot me-1"></i><%= sortedListings[i].location %>
                                <% if (sortedListings[i].country) { %>, <%= sortedListings[i].country %><% } %>
                            </div>
                            <%# View details button with data attributes for modal %>
                            <button class="btn btn-sm btn-outline-primary mt-auto view-details-btn" 
                                    data-id="<%= sortedListings[i]._id %>"
                                    data-title="<%= sortedListings[i].title %>"
                                    data-price="<%= sortedListings[i].price.toLocaleString('en-IN') %>"
                                    data-location="<%= sortedListings[i].location %><% if (sortedListings[i].country) { %>, <%= sortedListings[i].country %><% } %>"
                                    data-image="<%= sortedListings[i].image.url %>"
                                    data-reviews="<%= sortedListings[i].reviews ? sortedListings[i].reviews.length : 0 %>">
                                <i class="fas fa-eye me-1"></i> View Details
                            </button>
                        </div>
                    </div>
                </div>
            <% } %>
    </div>

    <%# Empty state - Shown when no listings exist in the system (not for search results) %>
    <% if (allListing.length === 0 && (typeof searchQuery === 'undefined' || !searchQuery)) { %>
        <div class="text-center p-5">
            <i class="fa-solid fa-house-slash fs-1 text-muted mb-3"></i>
            <h3 class="text-muted">No listings available</h3>
            <p class="text-muted">Be the first to add a listing!</p>
            <a href="/listings/new" class="btn btn-danger px-4 py-2 mt-2">
                <i class="fa-solid fa-plus me-2"></i>Add Listing
            </a>
        </div>
    <% } %>
</div>

<%# Listing Details Modal - Pop-up for quick listing preview %>
<div class="modal fade" id="listingDetailsModal" tabindex="-1" aria-labelledby="listingDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="listingDetailsModalLabel">Listing Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <img id="modalImage" src="" alt="Listing image" class="img-fluid rounded mb-3 w-100" style="height: 250px; object-fit: cover;">
          </div>
          <div class="col-md-6">
            <h4 id="modalTitle"></h4>
            <p class="text-muted"><i class="fas fa-map-marker-alt me-2"></i><span id="modalLocation"></span></p>
            <p class="fs-5"><strong>₹<span id="modalPrice"></span></strong> <span class="text-muted">/ night</span></p>
            <p><i class="fas fa-star text-warning me-2"></i><span id="modalReviews"></span></p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <a id="viewFullDetails" href="" class="btn btn-primary">View Full Details</a>
      </div>
    </div>
  </div>
</div>

<style>
  .btn-clear {
    background-color: #717171;
    color: white;
    border: none;
    padding: 8px 24px;
    border-radius: 25px;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .btn-clear:hover {
    background-color: #5C5C5C;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .btn-apply, .btn-clear {
    min-width: 100px;
  }

  .btn-filter {
    background-color: #fff;
    color: #222;
    border: 1px solid #dddddd;
    padding: 8px 16px;
    border-radius: 30px;
    font-weight: 500;
    transition: all 0.2s ease;
    box-shadow: 0 1px 2px rgba(0,0,0,0.08);
  }

  .btn-filter:hover {
    border-color: #222;
    background-color: #f7f7f7;
  }

  .filter-actions {
    display: flex;
    gap: 12px;
  }

  .btn-filter-apply {
    color: #222;
    border: none;
    padding: 8px 20px;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.2s ease;
  }
  .btn-filter-clear {
    background-color: #fff;
    color: #222;
    border: 1px solid #dddddd;
    padding: 8px 20px;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .btn-filter-clear:hover {
    border-color: #222;
    background-color: #f7f7f7;
  }

  .filter-card {
    border: 1px solid #dddddd;
    border-radius: 12px;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Get all view details buttons
    const viewDetailsButtons = document.querySelectorAll('.view-details-btn');
    
    // Add click event to each button
    viewDetailsButtons.forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const id = this.getAttribute('data-id');
        const title = this.getAttribute('data-title');
        const price = this.getAttribute('data-price');
        const location = this.getAttribute('data-location');
        const image = this.getAttribute('data-image');
        const reviews = this.getAttribute('data-reviews');
        
        // Set modal content
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalLocation').textContent = location;
        document.getElementById('modalPrice').textContent = price;
        document.getElementById('modalImage').src = image;
        document.getElementById('viewFullDetails').href = `/listings/${id}`;
        
        // Set reviews text
        const reviewsCount = parseInt(reviews);
        if (reviewsCount > 0) {
          document.getElementById('modalReviews').textContent = `${reviewsCount} Reviews`;
        } else {
          document.getElementById('modalReviews').textContent = 'No reviews yet';
        }
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('listingDetailsModal'));
        modal.show();
      });
    });
  });

function clearFilters() {
    document.getElementById('country').value = 'all';
    document.getElementById('minPrice').value = '';
    document.getElementById('maxPrice').value = '';
    document.getElementById('filterForm').submit();
}

// Initialize popovers
document.addEventListener('DOMContentLoaded', function() {
    const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    const popoverList = popoverTriggerList.map(function(popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl, {
            trigger: 'hover'
        });
    });
});
</script>